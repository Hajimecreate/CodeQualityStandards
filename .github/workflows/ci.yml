name: å…±é€šã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯

on:
  workflow_call:
    secrets:
      GEMINI_API_KEY:
        required: true
    inputs:
      php-version:
        required: false
        type: string
        default: '8.2'
      node-version:
        required: false
        type: string
        default: '20'

permissions:
  contents: write      # æ•´å½¢å¾Œã®pushã«å¿…è¦
  pull-requests: write # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«å¿…è¦

jobs:
  # ã‚¸ãƒ§ãƒ–1: ã‚³ãƒ¼ãƒ‰æ•´å½¢ (Format)
  format:
    name: ã‚³ãƒ¼ãƒ‰æ•´å½¢ã¨ä¿®æ­£
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # å…±æœ‰ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: å…±æœ‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/code-quality-standards
          path: .shared-config
          sparse-checkout: configs

      # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«é…ç½®
      - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
        run: |
          cp .shared-config/configs/.prettierrc .
          cp .shared-config/configs/.php-cs-fixer.dist.php .

      # --- Prettier ---
      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Prettierã‚’å®Ÿè¡Œ (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ•´å½¢)
        run: |
          npm install -g prettier
          npx prettier --write "**/*.{js,jsx,ts,tsx,css,scss,html,php}" || true

      # --- PHP-CS-Fixer ---
      - name: PHPã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: php-cs-fixer

      - name: PHP-CS-Fixerã‚’å®Ÿè¡Œ (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ•´å½¢)
        run: php-cs-fixer fix --allow-risky=yes || true

      # --- Commit ---
      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # ã“ã“ãŒGitHubä¸Šã®ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã¨ã—ã¦æ®‹ã‚Šã¾ã™
          commit_message: "ğŸ¨ è‡ªå‹•æ•´å½¢ã‚’é©ç”¨ã—ã¾ã—ãŸ (Prettier & PHP-CS-Fixer)"
          branch: ${{ github.head_ref }}

  # ã‚¸ãƒ§ãƒ–2: AIãƒ¬ãƒ“ãƒ¥ãƒ¼ (Review)
  review:
    name: AIã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
    needs: format
    runs-on: ubuntu-latest
    if: always() # æ•´å½¢ã§ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã‚‚å®Ÿè¡Œã™ã‚‹
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # git diffã®ãŸã‚ã«å±¥æ­´ãŒå¿…è¦

      # å…±æœ‰ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: å…±æœ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/code-quality-standards
          path: .shared-config
          sparse-checkout: scripts

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install google-genai PyGithub

      - name: AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        # å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: python3 .shared-config/scripts/review.py