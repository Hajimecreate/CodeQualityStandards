name: Shared Quality Check & AI Review

on:
  workflow_call:
    secrets:
      GEMINI_API_KEY:
        required: true
    inputs:
      php-version:
        required: false
        type: string
        default: '8.2'
      node-version:
        required: false
        type: string
        default: '20'

permissions:
  contents: write
  pull-requests: write

jobs:
  # ã‚¸ãƒ§ãƒ–1: ã‚³ãƒ¼ãƒ‰æ•´å½¢ (Format)
  format:
    name: ã‚³ãƒ¼ãƒ‰æ•´å½¢ã¨ä¿®æ­£
    runs-on: ubuntu-latest
    steps:
      # 1. SPINE-Laravel ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # 2. å…±æœ‰ãƒªãƒã‚¸ãƒˆãƒªï¼ˆCodeQualityStandardsï¼‰ã‹ã‚‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      #    ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã®PATã‚„Tokenã¯ã€Organizationè¨­å®šæ¸ˆã¿ãªã‚‰ä¸è¦
      - name: å…±æœ‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/CodeQualityStandards
          path: .shared-config
          sparse-checkout: configs

      # 3. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼ï¼ˆã“ã‚ŒãŒãªã„ã¨æ•´å½¢ãƒ„ãƒ¼ãƒ«ãŒè¨­å®šã‚’èª­ã¿è¾¼ã‚ãªã„ï¼‰
      - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
        run: |
          cp .shared-config/configs/.prettierrc .
          # php-cs-fixerã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
          if [ -f .shared-config/configs/.php-cs-fixer.dist.php ]; then
            cp .shared-config/configs/.php-cs-fixer.dist.php .
          fi

      # --- Prettier ---
      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Prettierã‚’å®Ÿè¡Œ
        run: |
          npm install -g prettier
          npx prettier --write "**/*.{js,jsx,ts,tsx,css,scss,html,php}" || true

      # --- PHP-CS-Fixer ---
      - name: PHPã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: php-cs-fixer

      - name: PHP-CS-Fixerã‚’å®Ÿè¡Œ
        run: php-cs-fixer fix --allow-risky=yes || true

      # --- Commit ---
      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¨ è‡ªå‹•æ•´å½¢ã‚’é©ç”¨ã—ã¾ã—ãŸ (Prettier & PHP-CS-Fixer)"
          branch: ${{ github.head_ref }}

  # ã‚¸ãƒ§ãƒ–2: AIãƒ¬ãƒ“ãƒ¥ãƒ¼ (Review)
  review:
    name: AIã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
    needs: format
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 4. å…±æœ‰ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å–å¾—
      - name: å…±æœ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/CodeQualityStandards
          path: .shared-config
          sparse-checkout: scripts

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install google-genai PyGithub

      - name: AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        # ã€æœ€é‡è¦ã€‘ã“ã“ãŒ .github/scripts/... ã ã¨å¤±æ•—ã—ã¾ã™
        # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ (.shared-config) å†…ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
        run: python .shared-config/scripts/review.py
